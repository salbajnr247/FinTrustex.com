<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading - FinTrustEX</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    .trading-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      grid-gap: 1.5rem;
    }
    
    @media (max-width: 1200px) {
      .trading-layout {
        grid-template-columns: 1fr;
      }
    }
    
    .market-data, .order-form, .order-book-container, .recent-trades-container, .open-orders-container {
      background-color: var(--bg-card);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .market-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }
    
    .market-pair {
      display: flex;
      align-items: center;
    }
    
    .market-pair h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
      color: var(--text-primary);
    }
    
    .price-change {
      display: flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 0.25rem;
      font-weight: 600;
      margin-left: 1rem;
    }
    
    .price-change.positive {
      background-color: rgba(72, 187, 120, 0.1);
      color: rgb(39, 129, 79);
    }
    
    .price-change.negative {
      background-color: rgba(229, 62, 62, 0.1);
      color: rgb(155, 44, 44);
    }
    
    .price-change i {
      margin-right: 0.25rem;
    }
    
    .market-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-item {
      flex: 1;
      min-width: 150px;
      padding: 0.75rem;
      background-color: var(--bg-light);
      border-radius: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    
    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .order-form-tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .order-form-tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
    }
    
    .order-form-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .order-form-content {
      display: none;
    }
    
    .order-form-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      font-size: 1rem;
      background-color: var(--bg-input);
      color: var(--text-primary);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.25);
    }
    
    .order-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    
    .btn-buy {
      background-color: #38a169;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.25rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-buy:hover {
      background-color: #2f855a;
    }
    
    .btn-sell {
      background-color: #e53e3e;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.25rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-sell:hover {
      background-color: #c53030;
    }
    
    .btn-buy:disabled, .btn-sell:disabled {
      background-color: var(--text-muted);
      cursor: not-allowed;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    
    .order-book {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .order-book-column {
      width: 100%;
    }
    
    .order-book-header {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      padding: 0.5rem 0;
      font-weight: 600;
      font-size: 0.8rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    .order-book-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      padding: 0.5rem 0;
      font-size: 0.875rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
    }
    
    .order-book-row:hover {
      background-color: var(--bg-hover);
    }
    
    .price-cell {
      text-align: left;
    }
    
    .amount-cell {
      text-align: right;
    }
    
    .total-cell {
      text-align: right;
    }
    
    .price-ask {
      color: #e53e3e;
    }
    
    .price-bid {
      color: #38a169;
    }
    
    .recent-trades-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .recent-trades-table th, .recent-trades-table td {
      padding: 0.75rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }
    
    .recent-trades-table th {
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .recent-trades-table td.price-buy {
      color: #38a169;
    }
    
    .recent-trades-table td.price-sell {
      color: #e53e3e;
    }
    
    .recent-trades-container .table-container {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .open-orders-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .open-orders-table th, .open-orders-table td {
      padding: 0.75rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }
    
    .open-orders-table th {
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .btn-cancel {
      background-color: var(--bg-light);
      color: var(--text-secondary);
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-cancel:hover {
      background-color: #e53e3e;
      color: white;
    }
    
    .symbol-selector {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      background-color: var(--bg-input);
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    
    .symbol-selector:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.25);
    }
    
    .api-warning {
      background-color: rgba(237, 137, 54, 0.1);
      border: 1px solid rgba(237, 137, 54, 0.5);
      color: rgb(179, 98, 34);
      padding: 1rem;
      border-radius: 0.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
    }
    
    .api-warning i {
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }
    
    .api-warning a {
      color: rgb(179, 98, 34);
      text-decoration: underline;
      font-weight: 600;
    }
    
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 0.25rem;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 1rem 1.5rem;
      background-color: var(--bg-card);
      color: var(--text-primary);
      border-radius: 0.25rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-width: 350px;
      display: flex;
      align-items: center;
      transform: translateX(400px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .toast i {
      margin-right: 0.75rem;
      font-size: 1.25rem;
    }
    
    .toast-success i {
      color: #38a169;
    }
    
    .toast-error i {
      color: #e53e3e;
    }
    
    .toast-message {
      flex: 1;
    }
    
    .toast-close {
      color: var(--text-muted);
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <img src="../assets/images/logo.svg" alt="FinTrustEX" class="logo">
        <h1>FinTrustEX</h1>
      </div>
      <ul class="sidebar-menu">
        <li><a href="../dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="./market.html"><i class="fas fa-chart-line"></i> Market</a></li>
        <li class="active"><a href="./trade.html"><i class="fas fa-exchange-alt"></i> Trade</a></li>
        <li><a href="./wallet.html"><i class="fas fa-wallet"></i> Wallet</a></li>
        <li><a href="./history.html"><i class="fas fa-history"></i> History</a></li>
        <li><a href="./binance-settings.html"><i class="fas fa-key"></i> API Settings</a></li>
        <li><a href="./support.html"><i class="fas fa-headset"></i> Support</a></li>
        <li><a href="./settings.html"><i class="fas fa-cog"></i> Settings</a></li>
      </ul>
      <div class="sidebar-footer">
        <a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <header class="dashboard-header">
        <div class="header-left">
          <button id="sidebar-toggle" class="sidebar-toggle">
            <i class="fas fa-bars"></i>
          </button>
          <h2>Trading</h2>
        </div>
        <div class="header-right">
          <div class="user-account">
            <img src="../assets/images/default-avatar.svg" alt="User" class="user-avatar">
            <span class="username">Welcome, <span id="username">User</span></span>
          </div>
        </div>
      </header>

      <div class="dashboard-content">
        <!-- API Warning for non-connected users -->
        <div id="apiWarning" class="api-warning" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i>
          <div>
            <p>You are not connected to the Binance API. To trade with real assets, please <a href="./binance-settings.html">configure your API keys</a>.</p>
          </div>
        </div>

        <div class="trading-layout">
          <div class="trading-left">
            <!-- Market Data -->
            <div class="market-data">
              <div class="market-header">
                <div class="market-pair">
                  <select id="symbolSelector" class="symbol-selector">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="BNBUSDT">BNB/USDT</option>
                    <option value="ADAUSDT">ADA/USDT</option>
                    <option value="DOGEUSDT">DOGE/USDT</option>
                    <option value="XRPUSDT">XRP/USDT</option>
                    <option value="DOTUSDT">DOT/USDT</option>
                    <option value="SOLUSDT">SOL/USDT</option>
                  </select>
                  <div id="priceChange" class="price-change positive">
                    <i class="fas fa-caret-up"></i>
                    <span>0.00%</span>
                  </div>
                </div>
                <div id="currentPrice" class="current-price">
                  00000.00
                </div>
              </div>

              <div class="market-stats">
                <div class="stat-item">
                  <div class="stat-label">24h High</div>
                  <div id="high24h" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">24h Low</div>
                  <div id="low24h" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">24h Volume</div>
                  <div id="volume24h" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">24h Change</div>
                  <div id="change24h" class="stat-value">0.00%</div>
                </div>
              </div>
            </div>

            <!-- Order Book -->
            <div class="order-book-container">
              <h3 class="section-title">Order Book</h3>
              <div class="order-book">
                <div class="order-book-column asks">
                  <div class="order-book-header">
                    <div class="price-cell">Price (USDT)</div>
                    <div class="amount-cell">Amount</div>
                    <div class="total-cell">Total</div>
                  </div>
                  <div id="asksList">
                    <!-- Ask orders will be populated here -->
                    <div class="order-book-row">
                      <div class="price-cell price-ask">0.00</div>
                      <div class="amount-cell">0.00</div>
                      <div class="total-cell">0.00</div>
                    </div>
                  </div>
                </div>
                <div class="order-book-column bids">
                  <div class="order-book-header">
                    <div class="price-cell">Price (USDT)</div>
                    <div class="amount-cell">Amount</div>
                    <div class="total-cell">Total</div>
                  </div>
                  <div id="bidsList">
                    <!-- Bid orders will be populated here -->
                    <div class="order-book-row">
                      <div class="price-cell price-bid">0.00</div>
                      <div class="amount-cell">0.00</div>
                      <div class="total-cell">0.00</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent Trades -->
            <div class="recent-trades-container">
              <h3 class="section-title">Recent Trades</h3>
              <div class="table-container">
                <table class="recent-trades-table">
                  <thead>
                    <tr>
                      <th>Price</th>
                      <th>Amount</th>
                      <th>Value</th>
                      <th>Time</th>
                    </tr>
                  </thead>
                  <tbody id="recentTradesList">
                    <!-- Recent trades will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Open Orders -->
            <div class="open-orders-container" id="openOrdersContainer" style="display: none;">
              <h3 class="section-title">Open Orders</h3>
              <table class="open-orders-table">
                <thead>
                  <tr>
                    <th>Pair</th>
                    <th>Type</th>
                    <th>Side</th>
                    <th>Price</th>
                    <th>Amount</th>
                    <th>Filled</th>
                    <th>Date</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="openOrdersList">
                  <!-- Open orders will be populated here -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="trading-right">
            <!-- Order Form -->
            <div class="order-form">
              <div class="order-form-tabs">
                <div class="order-form-tab active" data-tab="limit">Limit</div>
                <div class="order-form-tab" data-tab="market">Market</div>
              </div>

              <!-- Limit Order Form -->
              <div id="limitOrderForm" class="order-form-content active">
                <div class="form-group">
                  <label for="limitPrice">Price (USDT)</label>
                  <input type="number" id="limitPrice" step="0.01" min="0" placeholder="Enter price">
                </div>
                <div class="form-group">
                  <label for="limitAmount">Amount</label>
                  <input type="number" id="limitAmount" step="0.001" min="0" placeholder="Enter amount">
                </div>
                <div class="form-group">
                  <label for="limitTotal">Total (USDT)</label>
                  <input type="number" id="limitTotal" step="0.01" min="0" placeholder="Total amount" readonly>
                </div>
                <div class="order-actions">
                  <button id="limitBuyBtn" class="btn-buy">Buy</button>
                  <button id="limitSellBtn" class="btn-sell">Sell</button>
                </div>
              </div>

              <!-- Market Order Form -->
              <div id="marketOrderForm" class="order-form-content">
                <div class="form-group">
                  <label for="marketAmount">Amount</label>
                  <input type="number" id="marketAmount" step="0.001" min="0" placeholder="Enter amount">
                </div>
                <div class="order-actions">
                  <button id="marketBuyBtn" class="btn-buy">Buy Market</button>
                  <button id="marketSellBtn" class="btn-sell">Sell Market</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <div id="toastMessage" class="toast-message">Operation successful</div>
    <button id="toastClose" class="toast-close">&times;</button>
  </div>

  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/sidebar.js"></script>
  <script src="../assets/js/binance-api-manager.js"></script>
  <script src="../assets/js/market-data-client.js"></script>
  <script>
    // Global variables
    let currentSymbol = 'BTCUSDT';
    let currentPrice = 0;
    let isApiKeyConfigured = false;
    let orderBook = { asks: [], bids: [] };
    
    // Check if user is authenticated
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Authentication check
        if (!isAuthenticated()) {
          window.location.href = '../login.html';
          return;
        }

        // Set username
        const user = getCurrentUser();
        if (user && user.username) {
          document.getElementById('username').textContent = user.username;
        }

        // Initialize Binance API manager
        await binanceApiManager.initialize();
        isApiKeyConfigured = binanceApiManager.isApiKeyConfigured();
        
        // Show/hide API warning
        document.getElementById('apiWarning').style.display = isApiKeyConfigured ? 'none' : 'block';
        
        // Show open orders container if connected to API
        document.getElementById('openOrdersContainer').style.display = isApiKeyConfigured ? 'block' : 'none';
        
        // Initialize order forms
        setupOrderForms();
        
        // Initialize tab switching
        setupTabs();
        
        // Initialize symbol selector
        document.getElementById('symbolSelector').addEventListener('change', function() {
          currentSymbol = this.value;
          // Reset UI
          resetTradeUI();
          // Fetch new symbol data
          fetchSymbolData();
          // Update order book
          fetchOrderBook();
          // Fetch recent trades
          fetchRecentTrades();
          // Fetch open orders if API is configured
          if (isApiKeyConfigured) {
            fetchOpenOrders();
          }
        });
        
        // Fetch initial data
        fetchSymbolData();
        fetchOrderBook();
        fetchRecentTrades();
        
        // Fetch open orders if API is configured
        if (isApiKeyConfigured) {
          fetchOpenOrders();
        }

        // Setup WebSocket for real-time data
        setupWebSocket();
        
        // Logout handler
        document.getElementById('logout-link').addEventListener('click', function(event) {
          event.preventDefault();
          logout();
          window.location.href = '../login.html';
        });
        
        // Close toast button
        document.getElementById('toastClose').addEventListener('click', function() {
          hideToast();
        });
      } catch (error) {
        console.error('Error initializing trading page:', error);
        showToast('Error initializing page: ' + error.message, true);
      }
    });
    
    function setupOrderForms() {
      // Limit order form
      const limitPrice = document.getElementById('limitPrice');
      const limitAmount = document.getElementById('limitAmount');
      const limitTotal = document.getElementById('limitTotal');
      
      // Calculate total when price or amount changes
      function calculateTotal() {
        if (limitPrice.value && limitAmount.value) {
          const price = parseFloat(limitPrice.value);
          const amount = parseFloat(limitAmount.value);
          if (!isNaN(price) && !isNaN(amount)) {
            limitTotal.value = (price * amount).toFixed(2);
          }
        }
      }
      
      limitPrice.addEventListener('input', calculateTotal);
      limitAmount.addEventListener('input', calculateTotal);
      
      // Buy/Sell button handlers
      document.getElementById('limitBuyBtn').addEventListener('click', function() {
        placeLimitOrder('buy');
      });
      
      document.getElementById('limitSellBtn').addEventListener('click', function() {
        placeLimitOrder('sell');
      });
      
      document.getElementById('marketBuyBtn').addEventListener('click', function() {
        placeMarketOrder('buy');
      });
      
      document.getElementById('marketSellBtn').addEventListener('click', function() {
        placeMarketOrder('sell');
      });
    }
    
    function setupTabs() {
      const tabs = document.querySelectorAll('.order-form-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // Remove active class from all tabs
          tabs.forEach(t => t.classList.remove('active'));
          
          // Add active class to clicked tab
          this.classList.add('active');
          
          // Hide all tab content
          document.querySelectorAll('.order-form-content').forEach(content => {
            content.classList.remove('active');
          });
          
          // Show the content for the active tab
          const tabName = this.getAttribute('data-tab');
          document.getElementById(tabName + 'OrderForm').classList.add('active');
        });
      });
    }
    
    function setupWebSocket() {
      try {
        // Get WebSocket URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}/ws`;
        
        // Connect to WebSocket
        marketDataClient.connect(wsUrl);
        
        // Set up handlers
        marketDataClient.onConnect(() => {
          console.log('Connected to market data stream');
          
          // Subscribe to trades for the current symbol
          marketDataClient.subscribe('trades', currentSymbol, null, (trade) => {
            // Update UI with new trade
            updateTradeUI(trade);
          });
          
          // Subscribe to depth (order book)
          marketDataClient.subscribe('depth', currentSymbol, null, (depth) => {
            // Update order book
            updateOrderBook(depth);
          });
        });
        
        marketDataClient.onDisconnect(() => {
          console.log('Disconnected from market data stream. Trying to reconnect...');
        });
        
        marketDataClient.onError((error) => {
          console.error('WebSocket error:', error);
        });
        
        // Start ping interval to keep connection alive
        setInterval(() => {
          marketDataClient.ping();
        }, 30000);
      } catch (error) {
        console.error('Error setting up WebSocket:', error);
      }
    }
    
    async function fetchSymbolData() {
      try {
        const tickerData = await binanceApiManager.getTicker(currentSymbol);
        updateTickerUI(tickerData);
      } catch (error) {
        console.error('Error fetching symbol data:', error);
        showToast('Error fetching market data', true);
      }
    }
    
    async function fetchOrderBook() {
      try {
        const bookData = await binanceApiManager.getOrderBook(currentSymbol, 10);
        orderBook.asks = bookData.asks;
        orderBook.bids = bookData.bids;
        updateOrderBookUI();
      } catch (error) {
        console.error('Error fetching order book:', error);
      }
    }
    
    async function fetchRecentTrades() {
      try {
        const trades = await binanceApiManager.getRecentTrades(currentSymbol, 10);
        updateRecentTradesUI(trades);
      } catch (error) {
        console.error('Error fetching recent trades:', error);
      }
    }
    
    async function fetchOpenOrders() {
      try {
        if (!isApiKeyConfigured) return;
        
        const orders = await binanceApiManager.getOpenOrders(currentSymbol);
        updateOpenOrdersUI(orders);
      } catch (error) {
        console.error('Error fetching open orders:', error);
        showToast('Failed to fetch open orders', true);
      }
    }
    
    function updateTickerUI(ticker) {
      // Update current price
      currentPrice = parseFloat(ticker.lastPrice);
      document.getElementById('currentPrice').textContent = formatPrice(currentPrice);
      
      // Update price input if empty
      const limitPriceInput = document.getElementById('limitPrice');
      if (!limitPriceInput.value) {
        limitPriceInput.value = currentPrice.toFixed(2);
      }
      
      // Update 24h stats
      document.getElementById('high24h').textContent = formatPrice(parseFloat(ticker.highPrice));
      document.getElementById('low24h').textContent = formatPrice(parseFloat(ticker.lowPrice));
      document.getElementById('volume24h').textContent = parseFloat(ticker.volume).toFixed(2);
      
      // Update price change
      const priceChangePercent = parseFloat(ticker.priceChangePercent);
      const priceChangeEl = document.getElementById('priceChange');
      const changeEl = document.getElementById('change24h');
      
      if (priceChangePercent >= 0) {
        priceChangeEl.className = 'price-change positive';
        priceChangeEl.innerHTML = `<i class="fas fa-caret-up"></i><span>${priceChangePercent.toFixed(2)}%</span>`;
        changeEl.className = 'stat-value positive';
        changeEl.textContent = `+${priceChangePercent.toFixed(2)}%`;
      } else {
        priceChangeEl.className = 'price-change negative';
        priceChangeEl.innerHTML = `<i class="fas fa-caret-down"></i><span>${Math.abs(priceChangePercent).toFixed(2)}%</span>`;
        changeEl.className = 'stat-value negative';
        changeEl.textContent = `${priceChangePercent.toFixed(2)}%`;
      }
    }
    
    function updateOrderBookUI() {
      const asksEl = document.getElementById('asksList');
      const bidsEl = document.getElementById('bidsList');
      
      // Clear previous data
      asksEl.innerHTML = '';
      bidsEl.innerHTML = '';
      
      // Sort asks (lowest first) and bids (highest first)
      const sortedAsks = [...orderBook.asks].sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]));
      const sortedBids = [...orderBook.bids].sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
      
      // Add asks (sell orders)
      sortedAsks.forEach(ask => {
        const price = parseFloat(ask[0]);
        const amount = parseFloat(ask[1]);
        const total = price * amount;
        
        const row = document.createElement('div');
        row.className = 'order-book-row';
        row.innerHTML = `
          <div class="price-cell price-ask">${formatPrice(price)}</div>
          <div class="amount-cell">${amount.toFixed(4)}</div>
          <div class="total-cell">${total.toFixed(2)}</div>
        `;
        
        // Click handler to fill the form
        row.addEventListener('click', () => {
          document.getElementById('limitPrice').value = price.toFixed(2);
          // Trigger the calculation of total
          const event = new Event('input');
          document.getElementById('limitPrice').dispatchEvent(event);
        });
        
        asksEl.appendChild(row);
      });
      
      // Add bids (buy orders)
      sortedBids.forEach(bid => {
        const price = parseFloat(bid[0]);
        const amount = parseFloat(bid[1]);
        const total = price * amount;
        
        const row = document.createElement('div');
        row.className = 'order-book-row';
        row.innerHTML = `
          <div class="price-cell price-bid">${formatPrice(price)}</div>
          <div class="amount-cell">${amount.toFixed(4)}</div>
          <div class="total-cell">${total.toFixed(2)}</div>
        `;
        
        // Click handler to fill the form
        row.addEventListener('click', () => {
          document.getElementById('limitPrice').value = price.toFixed(2);
          // Trigger the calculation of total
          const event = new Event('input');
          document.getElementById('limitPrice').dispatchEvent(event);
        });
        
        bidsEl.appendChild(row);
      });
    }
    
    function updateOrderBook(depthUpdate) {
      // Update asks
      if (depthUpdate.asks && depthUpdate.asks.length > 0) {
        depthUpdate.asks.forEach(ask => {
          const price = ask[0];
          const quantity = parseFloat(ask[1]);
          
          // Find if we already have this price level
          const existingIndex = orderBook.asks.findIndex(a => a[0] === price);
          
          if (quantity === 0) {
            // Remove price level if quantity is 0
            if (existingIndex !== -1) {
              orderBook.asks.splice(existingIndex, 1);
            }
          } else if (existingIndex !== -1) {
            // Update existing price level
            orderBook.asks[existingIndex] = ask;
          } else {
            // Add new price level
            orderBook.asks.push(ask);
          }
        });
      }
      
      // Update bids
      if (depthUpdate.bids && depthUpdate.bids.length > 0) {
        depthUpdate.bids.forEach(bid => {
          const price = bid[0];
          const quantity = parseFloat(bid[1]);
          
          // Find if we already have this price level
          const existingIndex = orderBook.bids.findIndex(b => b[0] === price);
          
          if (quantity === 0) {
            // Remove price level if quantity is 0
            if (existingIndex !== -1) {
              orderBook.bids.splice(existingIndex, 1);
            }
          } else if (existingIndex !== -1) {
            // Update existing price level
            orderBook.bids[existingIndex] = bid;
          } else {
            // Add new price level
            orderBook.bids.push(bid);
          }
        });
      }
      
      // Update UI
      updateOrderBookUI();
    }
    
    function updateRecentTradesUI(trades) {
      const listEl = document.getElementById('recentTradesList');
      
      // Clear previous data
      listEl.innerHTML = '';
      
      // Add recent trades (newest first)
      trades.reverse().forEach(trade => {
        const price = parseFloat(trade.price);
        const amount = parseFloat(trade.qty);
        const total = price * amount;
        const time = new Date(trade.time).toLocaleTimeString();
        const isBuyer = trade.isBuyerMaker ? false : true;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="price-${isBuyer ? 'buy' : 'sell'}">${formatPrice(price)}</td>
          <td>${amount.toFixed(4)}</td>
          <td>${total.toFixed(2)}</td>
          <td>${time}</td>
        `;
        
        listEl.appendChild(row);
      });
    }
    
    function updateTradeUI(trade) {
      const listEl = document.getElementById('recentTradesList');
      
      // Create new row for the trade
      const row = document.createElement('tr');
      
      const price = parseFloat(trade.price);
      const amount = parseFloat(trade.quantity);
      const total = price * amount;
      const time = new Date(trade.time || Date.now()).toLocaleTimeString();
      const isBuyer = trade.isBuyerMaker ? false : true;
      
      row.innerHTML = `
        <td class="price-${isBuyer ? 'buy' : 'sell'}">${formatPrice(price)}</td>
        <td>${amount.toFixed(4)}</td>
        <td>${total.toFixed(2)}</td>
        <td>${time}</td>
      `;
      
      // Add to the beginning of the list
      if (listEl.firstChild) {
        listEl.insertBefore(row, listEl.firstChild);
      } else {
        listEl.appendChild(row);
      }
      
      // Remove excess rows to keep the list manageable
      while (listEl.children.length > 20) {
        listEl.removeChild(listEl.lastChild);
      }
      
      // Update current price
      currentPrice = price;
      document.getElementById('currentPrice').textContent = formatPrice(currentPrice);
    }
    
    function updateOpenOrdersUI(orders) {
      const listEl = document.getElementById('openOrdersList');
      
      // Clear previous data
      listEl.innerHTML = '';
      
      if (orders.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="8" style="text-align: center;">No open orders</td>
        `;
        listEl.appendChild(emptyRow);
        return;
      }
      
      // Add open orders
      orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.symbol}</td>
          <td>${order.type.toLowerCase()}</td>
          <td class="price-${order.side.toLowerCase() === 'buy' ? 'buy' : 'sell'}">${order.side}</td>
          <td>${parseFloat(order.price).toFixed(2)}</td>
          <td>${parseFloat(order.origQty).toFixed(4)}</td>
          <td>${parseFloat(order.executedQty).toFixed(4)}</td>
          <td>${new Date(order.time).toLocaleString()}</td>
          <td><button class="btn-cancel" data-order-id="${order.orderId}" data-symbol="${order.symbol}">Cancel</button></td>
        `;
        
        listEl.appendChild(row);
      });
      
      // Add cancel button handlers
      document.querySelectorAll('.btn-cancel').forEach(btn => {
        btn.addEventListener('click', async function() {
          const orderId = this.getAttribute('data-order-id');
          const symbol = this.getAttribute('data-symbol');
          
          if (confirm('Are you sure you want to cancel this order?')) {
            await cancelOrder(symbol, orderId);
          }
        });
      });
    }
    
    async function placeLimitOrder(side) {
      try {
        if (!isApiKeyConfigured) {
          showToast('Please configure your Binance API keys first', true);
          return;
        }
        
        const price = document.getElementById('limitPrice').value;
        const amount = document.getElementById('limitAmount').value;
        
        if (!price || !amount) {
          showToast('Please enter both price and amount', true);
          return;
        }
        
        const button = document.getElementById(`limit${side.charAt(0).toUpperCase() + side.slice(1)}Btn`);
        const originalText = button.textContent;
        button.disabled = true;
        button.innerHTML = `<span class="spinner"></span> Placing...`;
        
        let result;
        if (side === 'buy') {
          result = await binanceApiManager.placeLimitBuyOrder(currentSymbol, amount, price);
        } else {
          result = await binanceApiManager.placeLimitSellOrder(currentSymbol, amount, price);
        }
        
        showToast(`${side.charAt(0).toUpperCase() + side.slice(1)} order placed successfully!`);
        
        // Reset form
        document.getElementById('limitAmount').value = '';
        document.getElementById('limitTotal').value = '';
        
        // Refresh open orders
        fetchOpenOrders();
      } catch (error) {
        console.error('Error placing limit order:', error);
        showToast(`Error placing order: ${error.message}`, true);
      } finally {
        const button = document.getElementById(`limit${side.charAt(0).toUpperCase() + side.slice(1)}Btn`);
        button.disabled = false;
        button.textContent = side === 'buy' ? 'Buy' : 'Sell';
      }
    }
    
    async function placeMarketOrder(side) {
      try {
        if (!isApiKeyConfigured) {
          showToast('Please configure your Binance API keys first', true);
          return;
        }
        
        const amount = document.getElementById('marketAmount').value;
        
        if (!amount) {
          showToast('Please enter an amount', true);
          return;
        }
        
        const button = document.getElementById(`market${side.charAt(0).toUpperCase() + side.slice(1)}Btn`);
        const originalText = button.textContent;
        button.disabled = true;
        button.innerHTML = `<span class="spinner"></span> Placing...`;
        
        let result;
        if (side === 'buy') {
          result = await binanceApiManager.placeMarketBuyOrder(currentSymbol, amount);
        } else {
          result = await binanceApiManager.placeMarketSellOrder(currentSymbol, amount);
        }
        
        showToast(`${side.charAt(0).toUpperCase() + side.slice(1)} order executed successfully!`);
        
        // Reset form
        document.getElementById('marketAmount').value = '';
        
        // Refresh open orders (though market orders should execute immediately)
        fetchOpenOrders();
      } catch (error) {
        console.error('Error placing market order:', error);
        showToast(`Error placing order: ${error.message}`, true);
      } finally {
        const button = document.getElementById(`market${side.charAt(0).toUpperCase() + side.slice(1)}Btn`);
        button.disabled = false;
        button.textContent = side === 'buy' ? 'Buy Market' : 'Sell Market';
      }
    }
    
    async function cancelOrder(symbol, orderId) {
      try {
        const result = await binanceApiManager.cancelOrder(symbol, orderId);
        showToast('Order cancelled successfully!');
        
        // Refresh open orders
        fetchOpenOrders();
      } catch (error) {
        console.error('Error cancelling order:', error);
        showToast(`Error cancelling order: ${error.message}`, true);
      }
    }
    
    function resetTradeUI() {
      // Reset price and order book
      document.getElementById('currentPrice').textContent = '0.00';
      document.getElementById('asksList').innerHTML = '';
      document.getElementById('bidsList').innerHTML = '';
      
      // Reset stats
      document.getElementById('high24h').textContent = '0.00';
      document.getElementById('low24h').textContent = '0.00';
      document.getElementById('volume24h').textContent = '0.00';
      document.getElementById('change24h').textContent = '0.00%';
      
      // Reset order forms
      document.getElementById('limitPrice').value = '';
      document.getElementById('limitAmount').value = '';
      document.getElementById('limitTotal').value = '';
      document.getElementById('marketAmount').value = '';
      
      // Reset recent trades
      document.getElementById('recentTradesList').innerHTML = '';
      
      // Reset open orders
      document.getElementById('openOrdersList').innerHTML = '';
    }
    
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const messageEl = document.getElementById('toastMessage');
      
      // Set message
      messageEl.textContent = message;
      
      // Set icon and class
      if (isError) {
        toast.innerHTML = `
          <i class="fas fa-exclamation-circle"></i>
          <div id="toastMessage" class="toast-message">${message}</div>
          <button id="toastClose" class="toast-close">&times;</button>
        `;
        toast.className = 'toast toast-error show';
      } else {
        toast.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <div id="toastMessage" class="toast-message">${message}</div>
          <button id="toastClose" class="toast-close">&times;</button>
        `;
        toast.className = 'toast toast-success show';
      }
      
      // Show toast
      toast.classList.add('show');
      
      // Hide toast after 5 seconds
      setTimeout(hideToast, 5000);
      
      // Re-attach close button handler
      document.getElementById('toastClose').addEventListener('click', hideToast);
    }
    
    function hideToast() {
      const toast = document.getElementById('toast');
      toast.classList.remove('show');
    }
    
    function formatPrice(price) {
      if (price >= 1000) {
        return price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      } else if (price >= 1) {
        return price.toFixed(2);
      } else {
        return price.toFixed(6);
      }
    }
  </script>
</body>
</html>