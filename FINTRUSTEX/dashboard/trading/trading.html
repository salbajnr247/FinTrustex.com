<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinTrustEX - Trading</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <link rel="stylesheet" href="../../assets/css/trading.css">
  <link rel="stylesheet" href="../../assets/css/responsive.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dark-theme">
  <div class="trading-wrapper">
    <header class="navbar" id="navbar-container">
      <div class="navbar" role="banner">
        <div class="navbar-left">
          <button class="hamburger" aria-label="Toggle sidebar" id="hamburger-toggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="logo">FinTrustEX</div>
        </div>
        <h2 class="greeting">Welcome back, <span id="username">User</span> ðŸ‘‹</h2>
        <div class="nav-actions">
          <button class="btn deposit" data-nav="/dashboard/wallet#deposit" aria-label="Deposit funds">Deposit</button>
          <button class="btn withdraw" data-nav="/dashboard/wallet#withdraw" aria-label="Withdraw funds">Withdraw</button>
          <button class="btn trade" data-nav="/dashboard/trading" aria-label="Start trading">Trade Now</button>
          <button class="btn theme-toggle" aria-label="Toggle dark/light mode" id="theme-toggle">Toggle Theme</button>
          <button class="btn ar-toggle" aria-label="Toggle AR mode" id="ar-toggle">AR Mode</button>
          <div class="profile">
            <img src="/assets/images/profile.png" alt="User Profile" class="profile-img">
            <span class="profile-name">Trader!</span>
          </div>
        </div>
      </div>
    </header>
    <div class="container">
      <aside class="sidebar" id="sidebar-container"></aside>
      <main class="main-content" id="app">
        <section id="index">
          <h1 class="section-title">Trading</h1>
          <div class="trading-grid">
            <div class="chart-container card glassmorph">
              <canvas id="price-chart"></canvas>
              <p>Test Chart Placeholder</p>
            </div>
            <div class="order-book card glassmorph">
              <h3>Order Book</h3>
              <div id="order-book">
                <p>Bid: 60000 USDT @ 1 BTC</p>
                <p>Ask: 61000 USDT @ 1 BTC</p>
              </div>
            </div>
            <div class="trade-form card glassmorph">
              <h3>Place Order</h3>
              <form id="trade-form">
                <label for="pair">Trading Pair</label>
                <select id="pair" class="glassmorph-input" aria-label="Trading Pair">
                  <option value="BTC/USDT">BTC/USDT</option>
                  <option value="ETH/USDT">ETH/USDT</option>
                </select>
                <label for="order-type">Order Type</label>
                <select id="order-type" class="glassmorph-input" aria-label="Order Type">
                  <option value="limit">Limit</option>
                  <option value="market">Market</option>
                </select>
                <input type="number" id="amount" class="glassmorph-input" placeholder="Amount" required />
                <input type="number" id="price" class="glassmorph-input" placeholder="Price" required />
                <button type="submit" class="btn btn-yellow"><i class="fas fa-shopping-cart"></i> Buy</button>
                <button type="button" class="btn btn-outline"><i class="fas fa-arrow-right"></i> Sell</button>
              </form>
              <form id="price-alert-form">
                <h3>Set Price Alert</h3>
                <input type="number" id="alert-price" class="glassmorph-input" placeholder="Alert Price" required />
                <button type="submit" class="btn btn-yellow"><i class="fas fa-bell"></i> Set Alert</button>
              </form>
            </div>
            <div class="trade-history card glassmorph">
              <h3>Trade History</h3>
              <div id="trade-history">
                <p>2025-04-17: Bought 0.1 BTC @ 60000 USDT</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
    <footer class="footer" id="footer-container"></footer>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
    
    <script src="../../assets/js/api.js"></script>
    <script src="../../assets/js/auth-service.js"></script>
    <script src="../../assets/js/market-data-service.js"></script>
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/components.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/trading.js"></script>
    
    <script>
      // Check authentication on page load
      document.addEventListener('DOMContentLoaded', () => {
        if (window.authService) {
          // Redirect to login if not authenticated
          if (!authService.isAuthenticated()) {
            window.location.href = '../../auth.html?redirect=' + encodeURIComponent(window.location.pathname);
          } else {
            // If authenticated, update user info in header
            const user = authService.getCurrentUser();
            if (user) {
              const usernameElement = document.getElementById('username');
              const profileNameElement = document.querySelector('.profile-name');
              
              if (usernameElement) {
                usernameElement.textContent = user.username || user.email;
              }
              
              if (profileNameElement) {
                profileNameElement.textContent = user.username || 'Trader';
              }
            }
            
            // Initialize trading components
            // This will be called from trading.js
          }
        }
        
        // Initialize AOS animations
        AOS.init({ duration: 800 });
      });
      
      // Connect to WebSocket server for real-time updates
      const connectToWebSocket = () => {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        
        try {
          const socket = new WebSocket(wsUrl);
          
          socket.onopen = () => {
            console.log('Connected to WebSocket server');
            
            // Subscribe to price updates
            socket.send(JSON.stringify({
              type: 'subscribe',
              channel: 'price_updates'
            }));
          };
          
          socket.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              console.log('WebSocket message received:', data);
              
              // Handle different message types
              switch (data.type) {
                case 'price_update':
                  handlePriceUpdate(data.data);
                  break;
                case 'order_update':
                  handleOrderUpdate(data.data);
                  break;
                case 'transaction_update':
                  handleTransactionUpdate(data.data);
                  break;
                case 'ping':
                  // Respond to ping with pong
                  socket.send(JSON.stringify({ type: 'pong', timestamp: new Date().toISOString() }));
                  break;
              }
            } catch (error) {
              console.error('Error processing WebSocket message:', error);
            }
          };
          
          socket.onclose = (event) => {
            console.log('WebSocket connection closed:', event);
            
            // Attempt to reconnect after a short delay
            setTimeout(connectToWebSocket, 5000);
          };
          
          socket.onerror = (error) => {
            console.error('WebSocket error:', error);
          };
          
          return socket;
        } catch (error) {
          console.error('Failed to connect to WebSocket:', error);
          return null;
        }
      };
      
      // Handle price updates
      function handlePriceUpdate(data) {
        // Update price display
        const pairs = data.pairs;
        if (!pairs || !Array.isArray(pairs)) return;
        
        // Find the current pair in the dropdown
        const pairSelect = document.getElementById('pair');
        const currentPair = pairSelect ? pairSelect.value : 'BTC/USDT';
        
        // Find matching pair data
        const pairData = pairs.find(p => p.symbol === currentPair);
        if (pairData) {
          // Update price on UI
          updatePriceDisplay(pairData);
        }
      }
      
      // Update price display
      function updatePriceDisplay(pairData) {
        // Update current price
        const priceDisplay = document.querySelector('.chart-container h3');
        if (priceDisplay) {
          priceDisplay.innerHTML = `
            ${pairData.symbol}: ${utils.formatCurrency(pairData.price)} 
            <span class="${pairData.change >= 0 ? 'positive' : 'negative'}">
              ${utils.formatPercentage(pairData.change)}
            </span>
          `;
        }
        
        // Update input placeholder
        const priceInput = document.getElementById('price');
        if (priceInput) {
          priceInput.placeholder = `Price (current: ${utils.formatCurrency(pairData.price)})`;
        }
      }
      
      // Handle order updates
      function handleOrderUpdate(data) {
        // Refresh order history
        if (typeof updateOrderHistory === 'function') {
          updateOrderHistory(data);
        }
      }
      
      // Handle transaction updates
      function handleTransactionUpdate(data) {
        // Refresh transaction history
        if (typeof updateTransactionHistory === 'function') {
          updateTransactionHistory(data);
        }
      }
      
      // Connect to WebSocket when the page loads
      document.addEventListener('DOMContentLoaded', connectToWebSocket);
    </script>
  </div>
</body>
</html>